<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:wms_android.ViewModels"
             xmlns:models="clr-namespace:wms_android.shared.Models;assembly=wms_android.shared"
             x:Class="wms_android.Views.AllParcelsView"
             x:DataType="viewmodels:AllParcelsViewModel"
             BackgroundColor="{StaticResource Background}"
             Title="All Parcels">

    <Grid RowDefinitions="Auto,*">
        <!-- Loading indicator -->
        <ActivityIndicator Grid.RowSpan="2" 
                           IsRunning="{Binding IsLoading}"
                           IsVisible="{Binding IsLoading}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />

        <!-- Filter Section -->
        <StackLayout Grid.Row="0" Padding="15" BackgroundColor="{StaticResource PrimaryLight}" Spacing="10">
            <Label Text="Filter Parcels" 
                   FontSize="16" 
                   FontAttributes="Bold"
                   TextColor="{StaticResource PrimaryDark}" />

            <!-- Date Range -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                <StackLayout Grid.Column="0">
                    <Label Text="From Date" FontSize="12" TextColor="{StaticResource PrimaryDark}"/>
                    <DatePicker Date="{Binding FromDate}" />
                </StackLayout>
                <StackLayout Grid.Column="1">
                    <Label Text="To Date" FontSize="12" TextColor="{StaticResource PrimaryDark}"/>
                    <DatePicker Date="{Binding ToDate}" />
                </StackLayout>
            </Grid>

            <!-- Payment Mode and Destination -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                <StackLayout Grid.Column="0">
                    <Label Text="Payment Mode" FontSize="12" TextColor="{StaticResource PrimaryDark}"/>
                    <Picker ItemsSource="{Binding PaymentModes}" 
                            SelectedItem="{Binding SelectedPaymentMode}" />
                </StackLayout>
                <StackLayout Grid.Column="1">
                    <Label Text="Destination" FontSize="12" TextColor="{StaticResource PrimaryDark}"/>
                    <Picker ItemsSource="{Binding Destinations}" 
                            SelectedItem="{Binding SelectedDestination}" />
                </StackLayout>
            </Grid>

            <!-- Filter Buttons -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                <Button Grid.Column="0" 
                        Text="Apply Filters" 
                        Command="{Binding ApplyFiltersCommand}"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White" />
                <Button Grid.Column="1" 
                        Text="Clear Filters" 
                        Command="{Binding ClearFiltersCommand}"
                        BackgroundColor="{StaticResource Secondary}"
                        TextColor="{StaticResource PrimaryDark}" />
            </Grid>
        </StackLayout>

        <!-- Parcels List -->
        <CollectionView Grid.Row="1" 
                        ItemsSource="{Binding FilteredParcels}"
                        IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                        BackgroundColor="{StaticResource Background}">
            <CollectionView.EmptyView>
                <StackLayout HorizontalOptions="Center" VerticalOptions="Center">
                    <Label Text="No parcels found" 
                           FontSize="16" 
                           TextColor="{StaticResource PrimaryDark}"
                           HorizontalOptions="Center" />
                    <Label Text="Try adjusting your filters" 
                           FontSize="12" 
                           TextColor="{StaticResource PrimaryDark}"
                           HorizontalOptions="Center" />
                </StackLayout>
            </CollectionView.EmptyView>
            
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Parcel">
                    <Grid Padding="15,10">
                        <Frame BackgroundColor="White"
                               BorderColor="{StaticResource PrimaryLight}"
                               CornerRadius="10"
                               Padding="15"
                               HasShadow="True">
                            <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" RowSpacing="8">
                                
                                <!-- Header: Waybill and Status -->
                                <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                    <Label Grid.Column="0" 
                                           Text="{Binding WaybillNumber, StringFormat='Waybill: {0}'}" 
                                           FontSize="14" 
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource PrimaryDark}" />
                                    <Label Grid.Column="1" 
                                           Text="{Binding Status}" 
                                           FontSize="12"
                                           TextColor="{StaticResource Primary}"
                                           FontAttributes="Bold" />
                                </Grid>

                                <!-- Sender and Receiver -->
                                <Grid Grid.Row="1" ColumnDefinitions="*,*" ColumnSpacing="10">
                                    <StackLayout Grid.Column="0">
                                        <Label Text="From:" FontSize="10" TextColor="{StaticResource PrimaryDark}" FontAttributes="Bold"/>
                                        <Label Text="{Binding Sender}" FontSize="12" TextColor="{StaticResource PrimaryDark}"/>
                                    </StackLayout>
                                    <StackLayout Grid.Column="1">
                                        <Label Text="To:" FontSize="10" TextColor="{StaticResource PrimaryDark}" FontAttributes="Bold"/>
                                        <Label Text="{Binding Receiver}" FontSize="12" TextColor="{StaticResource PrimaryDark}"/>
                                    </StackLayout>
                                </Grid>

                                <!-- Description and Quantity -->
                                <Grid Grid.Row="2" ColumnDefinitions="2*,*" ColumnSpacing="10">
                                    <StackLayout Grid.Column="0">
                                        <Label Text="Description:" FontSize="10" TextColor="{StaticResource PrimaryDark}" FontAttributes="Bold"/>
                                        <Label Text="{Binding Description}" FontSize="12" TextColor="{StaticResource PrimaryDark}"/>
                                    </StackLayout>
                                    <StackLayout Grid.Column="1">
                                        <Label Text="Qty:" FontSize="10" TextColor="{StaticResource PrimaryDark}" FontAttributes="Bold"/>
                                        <Label Text="{Binding Quantity}" FontSize="12" TextColor="{StaticResource PrimaryDark}"/>
                                    </StackLayout>
                                </Grid>

                                <!-- Amount, Payment Mode and Destination -->
                                <Grid Grid.Row="3" ColumnDefinitions="*,*,*" ColumnSpacing="10">
                                    <StackLayout Grid.Column="0">
                                        <Label Text="Amount:" FontSize="10" TextColor="{StaticResource PrimaryDark}" FontAttributes="Bold"/>
                                        <Label Text="{Binding Amount, StringFormat='Ksh {0:N2}'}" FontSize="12" TextColor="{StaticResource Primary}" FontAttributes="Bold"/>
                                    </StackLayout>
                                    <StackLayout Grid.Column="1">
                                        <Label Text="Payment:" FontSize="10" TextColor="{StaticResource PrimaryDark}" FontAttributes="Bold"/>
                                        <Label Text="{Binding PaymentMethods}" FontSize="12" TextColor="{StaticResource PrimaryDark}"/>
                                    </StackLayout>
                                    <StackLayout Grid.Column="2">
                                        <Label Text="Destination:" FontSize="10" TextColor="{StaticResource PrimaryDark}" FontAttributes="Bold"/>
                                        <Label Text="{Binding Destination}" FontSize="12" TextColor="{StaticResource PrimaryDark}"/>
                                    </StackLayout>
                                </Grid>

                                <!-- Date -->
                                <Label Grid.Row="4" 
                                       Text="{Binding CreatedAt, StringFormat='Created: {0:MMM dd, yyyy}'}" 
                                       FontSize="10" 
                                       TextColor="{StaticResource Secondary}"
                                       HorizontalOptions="End" />
                            </Grid>
                        </Frame>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>